<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BIP-119 Emulation - Designing Bitcoin Contracts with Sapio</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="title-page.html">The Sapio Language</a></li><li class="chapter-item expanded affix "><a href="ch00-00-introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">ABC 123</li><li class="chapter-item expanded "><a href="ch01-00-getting-started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch01-01-installation.html"><strong aria-hidden="true">1.1.</strong> Installing Sapio</a></li><li class="chapter-item expanded "><a href="ch01-02-learn-rust.html"><strong aria-hidden="true">1.2.</strong> Learning Rust</a></li><li class="chapter-item expanded "><a href="ch01-03-hello-world.html"><strong aria-hidden="true">1.3.</strong> Hello World</a></li></ol></li><li class="chapter-item expanded "><a href="ch02-00-bip-119.html"><strong aria-hidden="true">2.</strong> BIP-119 CTV Fundamentals</a></li><li class="chapter-item expanded "><a href="ch03-00-basics.html"><strong aria-hidden="true">3.</strong> Sapio Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-01-guts.html"><strong aria-hidden="true">3.1.</strong> Contract Guts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-01-miniscript.html"><strong aria-hidden="true">3.1.1.</strong> Miniscript/Policy</a></li><li class="chapter-item expanded "><a href="ch03-01-builder.html"><strong aria-hidden="true">3.1.2.</strong> Template Builder</a></li><li class="chapter-item expanded "><a href="ch03-01-timelocks.html"><strong aria-hidden="true">3.1.3.</strong> Time Locks</a></li><li class="chapter-item expanded "><a href="ch03-01-amounts.html"><strong aria-hidden="true">3.1.4.</strong> Sats and Coins</a></li></ol></li><li class="chapter-item expanded "><a href="ch03-02-guts.html"><strong aria-hidden="true">3.2.</strong> Contract Actions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-02-guard.html"><strong aria-hidden="true">3.2.1.</strong> guard!</a></li><li class="chapter-item expanded "><a href="ch03-02-compile_if.html"><strong aria-hidden="true">3.2.2.</strong> compile_if!</a></li><li class="chapter-item expanded "><a href="ch03-02-then.html"><strong aria-hidden="true">3.2.3.</strong> then!</a></li><li class="chapter-item expanded "><a href="ch03-02-finish.html"><strong aria-hidden="true">3.2.4.</strong> finish!</a></li><li class="chapter-item expanded "><a href="ch03-02-when-use-macros.html"><strong aria-hidden="true">3.2.5.</strong> When to use macros?</a></li></ol></li><li class="chapter-item expanded "><a href="ch03-03-declarations.html"><strong aria-hidden="true">3.3.</strong> Contract Declarations</a></li><li class="chapter-item expanded "><a href="ch03-04-compliation.html"><strong aria-hidden="true">3.4.</strong> Contract Compilation Overview</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Exercises</li><li class="chapter-item expanded "><a href="ch04-00-sapio-fun-profit.html"><strong aria-hidden="true">4.</strong> Sapio for Fun (and Profit)</a></li><li class="chapter-item expanded affix "><li class="part-title">Warnings</li><li class="chapter-item expanded "><a href="ch05-00-limitations.html"><strong aria-hidden="true">5.</strong> Limitations of Sapio</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch05-01-ctv-emulator.html" class="active"><strong aria-hidden="true">5.1.</strong> BIP-119 Emulation</a></li><li class="chapter-item expanded "><a href="ch05-02-taproot.html"><strong aria-hidden="true">5.2.</strong> No Taproot</a></li><li class="chapter-item expanded "><a href="ch05-03-txns.html"><strong aria-hidden="true">5.3.</strong> Advanced Transaction Handling</a></li><li class="chapter-item expanded "><a href="ch05-04-gas.html"><strong aria-hidden="true">5.4.</strong> Mempool &amp; Fees</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Advanced Topics</li><li class="chapter-item expanded "><a href="ch06-00-packaging.html"><strong aria-hidden="true">6.</strong> Application Packaging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch06-01-wasm.html"><strong aria-hidden="true">6.1.</strong> WASM</a></li><li class="chapter-item expanded "><a href="ch06-02-rust.html"><strong aria-hidden="true">6.2.</strong> Rust Lib/Bin</a></li></ol></li><li class="chapter-item expanded "><a href="ch07-00-cli.html"><strong aria-hidden="true">7.</strong> Sapio CLI</a></li><li class="chapter-item expanded "><a href="ch08-00-useful-rust.html"><strong aria-hidden="true">8.</strong> Advanced Rust Patterns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch08-01-state-machines.html"><strong aria-hidden="true">8.1.</strong> Type Level State Machines</a></li><li class="chapter-item expanded "><a href="ch08-02-tryfrom.html"><strong aria-hidden="true">8.2.</strong> TryFrom Constructors</a></li><li class="chapter-item expanded "><a href="ch08-03-concrete.html"><strong aria-hidden="true">8.3.</strong> Concrete &amp; Generic Types</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Designing Bitcoin Contracts with Sapio</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/sapio-lang/sapio" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bip-119-emulation"><a class="header" href="#bip-119-emulation">BIP-119 Emulation</a></h1>
<p>Changes to Bitcoin take a long time. The star player in making Sapio work is
BIP-119, and that might take a while to get merged. To get around this, Sapio
provides some tools to enable similar functionality today by emulating
BIP-119 with signatures.</p>
<h2 id="the-default-emulator"><a class="header" href="#the-default-emulator">The Default Emulator</a></h2>
<p>Sapio CTV Emulators defines implementations of a local emulator that can be
used by sapio compiler library users. To use such an emulator, a user can
generate a seed and create a contract. After creating the contract and
binding it to a specific UTXO, a user should be able to delete the seed,
ensuring that only the compiled logic may be used. Alternatively, they can
retain the seed and promise not to improperly use it.</p>
<p>This crate also defines logic for servers that want to offer emulator
services to remote compilers. This is convenient since the emulator server
must be kept secure, so an organization may want it to be more tightly
safeguarded.</p>
<p>The emulator definitions include wrapper types that compose individual
instances of an emulator into a federated multisig. This is useful
for circumstances where a contract is between e.g. 2 parties and both
have a emulator server. Then the contract can be &quot;immutable&quot; unless
both collude.</p>
<p>To aid in experimentation, Judica, Inc operates a public emulator server for
regtest.</p>
<pre><code class="language-json">[
    &quot;tpubD6NzVbkrYhZ4Wf398td3H8YhWBsXx9Sxa4W3cQWkNW3N3DHSNB2qtPoUMXrA6JNaPxodQfRpoZNE5tGM9iZ4xfUEFRJEJvfs8W5paUagYCE&quot;,
    &quot;ctv.d31373.org:8367&quot;
]
</code></pre>
<h3 id="how-it-works"><a class="header" href="#how-it-works">How it works</a></h3>
<p><em>See the source code for more detailed documentation.</em></p>
<p>CheckTemplateVerify essentially functions as a self-signed transaction. I.e.,
imagine you could create a public key that could only ever sign a transaction
which matched a certain pattern?</p>
<p>To implement this functionality, we use BIP-32 HD keys with public derivation.</p>
<p>On initialization, a server picks a seed S and generates a root public key K
from it, and publishes K.</p>
<p>Users generate a transaction T and extract the CheckTemplateVerify hash H for
it. They then take H and convert it into a derivation path D of 8 u32's and 1
u8 for non-hardened derivation (see <code>hash_to_child_vec</code>).</p>
<p>This derivation path is then applied to K to generate a key C. This key is
added with a CheckSig(SIGHASH_ALL) to the script in place of a CTV clause.</p>
<p>Then, when a user desires to spend an output with such a key, they create the
entire transaction they want to occur and send it to the the emulator server.</p>
<p>Without even checking to see that the key is used in the transaction, the
server generates the template hash H' (which should equal H) and then signs,
returning the signature to the client.</p>
<p>Before creating a contract, clients may wish to collect all possible
signatures required to prevent an availability fault.</p>
<p>This scheme has the benefit that:</p>
<ol>
<li>contract specification can occur without any online processes</li>
<li>The server has no intelligent logic, all guarantees are structural.</li>
<li>Server is completely stateless.</li>
<li>Availability/malfeasance can be controlled for with multisig</li>
<li>1:1 functionality mapping to CTV</li>
</ol>
<p>The downside of this approach to emulation is that:</p>
<ol>
<li>It is somewhat inefficient for scripts which have many branched possibilities.</li>
<li>No inherent mechanism to delete keys after use to protect against future exfiltration.</li>
</ol>
<h4 id="why-bip-32"><a class="header" href="#why-bip-32">Why BIP-32</a></h4>
<p>We use BIP-32 because it is a well studied primitive and derivation paths are
compatible with existing signing hardware. While it is true that a tweak of
32 bytes could be directly applied to the key more efficiently, easier
interoperability with existing tools seemed to be the best path.</p>
<h2 id="customizing-emulator-trait"><a class="header" href="#customizing-emulator-trait">Customizing Emulator Trait</a></h2>
<p>This emulator trait crate is a base that exports a trait definition and some
helper structs that are needed across the sapio ecosystem.</p>
<p>Defining the trait in its own crate allows us to use trait objects in our
compiler internals without needing to have the compiler directly depend on
e.g. networking primitives.</p>
<p>As a user of the Sapio library, you can define your own custom emulator logic
but that's out of scope of this book.</p>
<h2 id="future-work"><a class="header" href="#future-work">Future Work</a></h2>
<p><a href="https://github.com/sapio-lang/sapio/issues/100">There is a plan</a> to make
emulation more efficient based on Merkelization, but it is not yet
implemented because it messes with the current way the compiler works.</p>
<p>The efficiency issues are also solvable, more or less, with taproot.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="ch05-00-limitations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ch05-02-taproot.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="ch05-00-limitations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="ch05-02-taproot.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>
        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        
        <script src="ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
